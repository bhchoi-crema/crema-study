# Ch15 Choosing a Shard Key

샤딩에서 가장 중요하고 어려운 작업: 

샤드 키 선택하기 == 데이터를 어떤 식으로 분산시킬 것인가?

## 챕터 목표
1. 여러 후보들 중 샤드 키를 고를 때 어떤 기준으로 선택해야 하는가?
2. 샤드 키 사용 사례 살펴보기
3. 샤드 키로 사용할 수 없는 것은 무엇인가?
4. 데이터 분산 방식을 커스터마이즈할 때 사용할 수 있는 다른 대체 전략은 무엇인가?
5. 수동 데이터 샤딩은 어떻게 하는가?

## 1. 여러 후보들 중 샤드 키를 고를 때 어떤 기준으로 선택해야 하는가?
### 샤딩 전에 검토할 점들
- 몇 개의 샤드를 사용할 예정인가? 
  - 모든 샤드에 접근하는 쿼리를 많이 사용해야 한다면, 샤딩은 의미 없다. 클러스터가 커지더라도 거의 모든 쿼리는 항상 샤드 키를 가지고 특정한 샤드에만 접근하는 방식이어야 한다.
- 읽기&middot;쓰기 대기시간 감소를 위해 샤딩을 하는 것인가? 
  - 대기시간을 감소시키려면, 지리적으로 가깝거나 성능 좋은 머신으로 요청을 보낼 수 있어야 한다.
- 읽기&middot;쓰기 처리량을 증가를 위해 샤딩을 하는 것인가? 
  - 처리량을 증가시키려면, 병렬 처리 부분을 늘리고 요청을 클러스터 전체에 균등하게 보낼 수 있어야 한다.
- 일정 데이터 크기당 시스템 리소스량 증가를 위해 샤딩을 하는 것인가? 
  - 그러려면, 데이터셋을 가능한 작게 유지해야 한다.

위 질문들은 샤드 키의 평가기준이다. 이를 통해 자신의 상황에 맞는 샤드 키가 무엇인가 판단해 보자.

## 2. 샤드 키 사용 사례 살펴보기
### 샤드 키 종류
- 증가하는 샤드 키
  - 모든 청크가 하나의 샤드에서만 생성되기 때문에 청크를 고르게 분배하기 어려움. 좀 더 고르게 분산된 시스템에서는 상대적으로 쉽게 해결할 수 있는문제도, 여기서는 MongoDB가 청크를 계속해서 다른 샤드로 옮겨야만 해결할 수 있다.

- 랜덤 분산 샤드 키
  - 특정한 패턴이 없는 키들. 모든 샤드의 크기가 거의 같은 비율로 증가하여, 청크를 옮길 필요성이 줄어든다. 유일한 단점은 MongoDB가 RAM 크기 이상의 데이터에 랜덤하게 접근할 때 효율적이지 못하다는 것이다. 충분한 RAM을 활용할 수 있거나 (상대적으로) 속도가 중요하지 않다면, 랜덤 키를 통해 작업량을 클러스터 전체에 고르게 분산할 수 있다.

- 위치 기반 샤드 키
  - 유저 IP, 위도, 경도 같은 키들. 여기서 "위치"는 꼭 물리적 위치와 관련 있는 것만은 아니라, 크리마의 brand와 같이 데이터를 한데 묶을 수 있는 기준이라고 할 수 있다. 위치 기반 샤드 키는 데이터와 데이터의 실제 사용자 간 거리를 가깝게 유지하고, 관련 데이터를 같은 저장공간에 저장하도록 하는데 유용하다.
  
### 샤드 키 전략
- 해시드 샤드 키
- 파이어호스 전략
- 멀티 핫스팟

## 3. 샤드 키로 사용할 수 없는 것은 무엇인가?
### 샤드 키 규칙과 가이드라인
샤드 키 선택 방법은 인덱스 선택과 비슷하다. 사실 대게의 경우 가장 자주 사용하는 인덱스를 샤드 키로 사용한다.

### 샤드 키 제한
- 배열은 샤드 키가 될 수 없다.
- 입력한 샤드 키 값은 변경될 수 없다. 특정 다큐먼트의 샤드 키를 변경하려면, 해당 다큐먼트를 삭제하고, 키 값을 변경하여 새로 입력하는 수밖에 없다.
- Geospatial, Multikey, Text 인덱스는 샤드 키로 사용할 수 없다.

### 샤드 키 카디널리티
- 

## 4. 데이터 분산 방식을 커스터마이즈할 때 사용할 수 있는 다른 대체 전략은 무엇인가?

## 5. 수동 데이터 샤딩은 어떻게 하는가?
